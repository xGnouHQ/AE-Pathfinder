name: Deploy Test PoC

# WANN soll die Pipeline laufen? (Ersatz für "rules")
on:
  push:
    branches: [ "test-poc" ]
  pull_request:
    branches: [ "test-poc" ]

# Hier definieren wir die Jobs (Ersatz für "stages")
jobs:
  # --- STAGE 1: BUILD CHECK ---
  
  backend-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
          
      - name: Build Backend with Maven
        run: |
          cd pathfinder-backend
          mvn -B -DskipTests clean package

  frontend-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: pathfinder-frontend/package-lock.json
          
      - name: Build Frontend
        run: |
          cd pathfinder-frontend
          npm ci
          npm run build

  # --- STAGE 2: DEPLOY (REMOTE) ---
  
  deploy-remote:
    needs: [backend-build, frontend-build] # Wartet auf die Build-Jobs
    runs-on: ubuntu-latest
    # Nur laufen lassen, wenn es wirklich ein Push/Merge auf den Branch ist (kein PR Preview Deploy)
    if: github.event_name == 'push' 
    steps:
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh/
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          # Host Key automatisch akzeptieren (wie StrictHostKeyChecking no)
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Execute Remote Rebuild Script
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "bash -lc '
            set -euo pipefail

            echo \"=== 1. Git Sync (test-poc) ===\"
            cd ~/AE-Pathfinder
            git fetch --all --prune
            git checkout test-poc || git checkout -b test-poc origin/test-poc
            git reset --hard origin/test-poc

            echo \"=== 2. Backend neu bauen (Server) ===\"
            cd pathfinder-backend
            mvn -B -DskipTests clean package

            echo \"=== 3. Frontend neu bauen (Server) ===\"
            cd ../pathfinder-frontend
            if [ -f package-lock.json ]; then npm ci; else npm install; fi
            npm run build

            echo \"=== 4. Services neustarten (mit SUDO) ===\"
            sudo systemctl restart pathfinder-backend
            sudo systemctl restart pathfinder-frontend
          '"

  # --- STAGE 3: VERIFY ---

  verify-services:
    needs: [deploy-remote]
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh/
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Check Ports and Status
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "bash -lc '
            set -e

            echo \"--- Check Backend (Systemd) ---\"
            if sudo systemctl is-active --quiet pathfinder-backend; then
                echo \"✅ Backend Service läuft.\"
            else
                echo \"❌ Backend Service läuft NICHT!\"
                sudo systemctl status pathfinder-backend --no-pager
                exit 1
            fi

            echo \"--- Check Backend (Port 8080) ---\"
            if timeout 30 bash -c \"until echo > /dev/tcp/localhost/8080; do sleep 1; done\" 2>/dev/null; then
                echo \"✅ Port 8080 ist offen.\"
            else
                echo \"❌ Port 8080 antwortet nicht!\"
                exit 1
            fi

            echo \"--- Check Frontend (Systemd) ---\"
            if sudo systemctl is-active --quiet pathfinder-frontend; then
                echo \"✅ Frontend Service läuft.\"
            else
                echo \"❌ Frontend Service läuft NICHT!\"
                sudo systemctl status pathfinder-frontend --no-pager
                exit 1
            fi

            echo \"--- Check Frontend (Port 3000) ---\"
            if timeout 30 bash -c \"until echo > /dev/tcp/localhost/3000; do sleep 1; done\" 2>/dev/null; then
                echo \"✅ Port 3000 ist offen.\"
            else
                echo \"❌ Port 3000 antwortet nicht!\"
                exit 1
            fi
          '"
